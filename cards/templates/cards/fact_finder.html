{% extends 'cards/base.html' %}

{% block title %}Fact Finder - Debrief{% endblock %}

{% block extra_style %}
<style>
body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.fact-finder-container {
    max-width: 1200px;
    margin: 40px auto;
    padding: 0 20px;
}

.header-section {
    text-align: center;
    margin-bottom: 40px;
}

.main-title {
    font-size: 48px;
    font-weight: 900;
    color: white;
    margin-bottom: 16px;
    text-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.subtitle {
    font-size: 18px;
    color: rgba(255, 255, 255, 0.9);
    line-height: 1.6;
}

.search-section {
    background: white;
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    margin-bottom: 40px;
}

.topic-selector {
    margin-bottom: 24px;
}

.topic-label {
    font-size: 14px;
    font-weight: 700;
    color: #374151;
    margin-bottom: 12px;
    display: block;
}

.topic-tabs {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 8px;
}

.topic-tab {
    background: none;
    border: none;
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 600;
    color: #6b7280;
    cursor: pointer;
    border-radius: 8px 8px 0 0;
    transition: all 0.2s;
}

.topic-tab.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.topic-tab:hover:not(.active) {
    background: #f3f4f6;
}

.topic-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
    margin-bottom: 24px;
}

.topic-chip {
    background: #f9fafb;
    border: 2px solid #e5e7eb;
    padding: 12px 16px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    text-align: center;
}

.topic-chip:hover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.1);
}

.topic-chip.selected {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-color: #667eea;
    color: white;
}

.search-box {
    position: relative;
    margin-bottom: 20px;
}

.search-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 20px;
    color: #9ca3af;
}

.search-input {
    width: 100%;
    padding: 16px 16px 16px 48px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    font-size: 16px;
    transition: all 0.2s;
}

.search-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.search-btn {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 12px;
    color: white;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
}

.search-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
}

.search-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.results-section {
    background: white;
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    display: none;
}

.results-section.active {
    display: block;
}

.results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 3px solid #667eea;
}

.results-title {
    font-size: 24px;
    font-weight: 800;
    color: #1a1a2e;
}

.results-count {
    font-size: 14px;
    color: #6b7280;
}

.fact-card {
    background: linear-gradient(135deg, #f9fafb 0%, #e5e7eb 100%);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 16px;
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
}

.fact-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
    border-color: #667eea;
}

.fact-card.recommended {
    border-color: #10b981;
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(5, 150, 105, 0.05) 100%);
}

.recommended-badge {
    display: inline-block;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    font-size: 11px;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 12px;
    margin-bottom: 12px;
}

.fact-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.fact-type-icon {
    font-size: 18px;
}

.fact-type {
    font-size: 11px;
    text-transform: uppercase;
    color: #6b7280;
    font-weight: 700;
    letter-spacing: 0.5px;
}

.fact-title {
    font-size: 18px;
    font-weight: 700;
    color: #1a1a2e;
    margin-bottom: 8px;
    line-height: 1.4;
}

.fact-excerpt {
    color: #6b7280;
    font-size: 14px;
    line-height: 1.6;
    margin-bottom: 12px;
}

.ai-explanation {
    background: rgba(16, 185, 129, 0.1);
    border-left: 3px solid #10b981;
    padding: 10px 14px;
    margin: 12px 0;
    font-size: 13px;
    color: #374151;
    border-radius: 4px;
}

.ai-explanation strong {
    color: #10b981;
}

.fact-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.fact-source {
    font-size: 12px;
    color: #6b7280;
}

.fact-source a {
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
}

.fact-source a:hover {
    text-decoration: underline;
}

.save-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.save-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.loading {
    text-align: center;
    padding: 60px 20px;
}

.loading-spinner {
    font-size: 48px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    margin-top: 20px;
    font-size: 16px;
    color: #6b7280;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
}

.empty-icon {
    font-size: 64px;
    margin-bottom: 20px;
}

.empty-title {
    font-size: 20px;
    font-weight: 700;
    color: #1a1a2e;
    margin-bottom: 12px;
}

.empty-text {
    font-size: 14px;
    color: #6b7280;
}
</style>
{% endblock %}

{% block content %}
<div class="fact-finder-container">
    <div class="header-section">
        <h1 class="main-title">üîç Fact Finder</h1>
        <p class="subtitle">
            Search for credible facts, statistics, and research on any policy topic.<br>
            Save interesting findings directly to your notebook.
        </p>
    </div>

    <div class="search-section">
        <div class="topic-selector">
            <label class="topic-label">1. Choose a Policy Area</label>
            
            <div class="topic-tabs">
                <button class="topic-tab active" onclick="switchTab('federal')">
                    üèõÔ∏è Federal Issues
                </button>
                <button class="topic-tab" onclick="switchTab('state')">
                    üèõÔ∏è State Issues
                </button>
            </div>

            <div class="topic-grid" id="federalTopics">
                {% for code, name in federal_topics %}
                <div class="topic-chip" data-topic="{{ code }}" onclick="selectTopic('{{ code }}', '{{ name }}')">
                    {{ name }}
                </div>
                {% endfor %}
            </div>

            <div class="topic-grid" id="stateTopics" style="display: none;">
                {% for code, name in state_topics %}
                <div class="topic-chip" data-topic="{{ code }}" onclick="selectTopic('{{ code }}', '{{ name }}')">
                    {{ name }}
                </div>
                {% endfor %}
            </div>
        </div>

        <label class="topic-label">2. What would you like to know?</label>
        <div class="search-box">
            <span class="search-icon">üîç</span>
            <input 
                type="text" 
                class="search-input" 
                id="searchInput"
                placeholder="e.g., 'crime statistics', 'economic impact', 'recent studies'..."
                onkeypress="if(event.key === 'Enter') searchFacts()"
            >
        </div>

        <button class="search-btn" onclick="searchFacts()" id="searchBtn">
            Search for Facts
        </button>
    </div>

    <div class="results-section" id="resultsSection">
        <div class="results-header">
            <h2 class="results-title" id="resultsTitle">Search Results</h2>
            <span class="results-count" id="resultsCount"></span>
        </div>
        
        <div id="resultsContainer"></div>
    </div>
</div>

<script>
let selectedTopic = '';
let selectedTopicName = '';

function switchTab(tab) {
    // Update tab buttons
    document.querySelectorAll('.topic-tab').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Show/hide topic grids
    document.getElementById('federalTopics').style.display = tab === 'federal' ? 'grid' : 'none';
    document.getElementById('stateTopics').style.display = tab === 'state' ? 'grid' : 'none';
    
    // Clear selection
    document.querySelectorAll('.topic-chip').forEach(chip => {
        chip.classList.remove('selected');
    });
    selectedTopic = '';
    selectedTopicName = '';
}

function selectTopic(code, name) {
    // Clear previous selection
    document.querySelectorAll('.topic-chip').forEach(chip => {
        chip.classList.remove('selected');
    });
    
    // Select new topic
    event.target.classList.add('selected');
    selectedTopic = code;
    selectedTopicName = name;
}

function searchFacts() {
    const query = document.getElementById('searchInput').value.trim();
    
    if (!selectedTopic) {
        alert('Please select a policy area first');
        return;
    }
    
    if (!query) {
        alert('Please enter a search query');
        return;
    }
    
    // Show loading
    const resultsSection = document.getElementById('resultsSection');
    const resultsContainer = document.getElementById('resultsContainer');
    const resultsTitle = document.getElementById('resultsTitle');
    
    resultsSection.classList.add('active');
    resultsTitle.textContent = `Results for "${query}" in ${selectedTopicName}`;
    resultsContainer.innerHTML = `
        <div class="loading">
            <div class="loading-spinner">üîç</div>
            <div class="loading-text">Searching with AI assistance...</div>
        </div>
    `;
    
    // Scroll to results
    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    // Fetch results
    fetch(`/api/enhanced-fact-search/?q=${encodeURIComponent(query)}&topic=${selectedTopic}`)
        .then(response => response.json())
        .then(data => {
            displayResults(data);
        })
        .catch(error => {
            console.error('Search error:', error);
            resultsContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">‚ùå</div>
                    <div class="empty-title">Error loading results</div>
                    <div class="empty-text">Please try again</div>
                </div>
            `;
        });
}

function displayResults(data) {
    const resultsContainer = document.getElementById('resultsContainer');
    const resultsCount = document.getElementById('resultsCount');
    
    if (!data.results || data.results.length === 0) {
        resultsContainer.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üîç</div>
                <div class="empty-title">No results found</div>
                <div class="empty-text">Try different keywords or select a different topic</div>
            </div>
        `;
        resultsCount.textContent = '';
        return;
    }
    
    resultsCount.textContent = `${data.results.length} results${data.total_found > data.results.length ? ` (${data.total_found} total found)` : ''}`;
    
    let html = '';
    data.results.forEach(result => {
        const isRecommended = result.ai_recommended;
        const typeIcons = {
            'news': 'üì∞',
            'fact': 'üìä',
            'study': 'üìö',
            'overview': 'üìñ',
            'fact-check': '‚úì',
            'web-search': 'üåê'
        };
        const icon = typeIcons[result.type] || 'üìÑ';
        
        html += `
            <div class="fact-card ${isRecommended ? 'recommended' : ''}" onclick="window.open('${result.url}', '_blank')">
                ${isRecommended ? '<div class="recommended-badge">‚≠ê AI Recommended</div>' : ''}
                
                <div class="fact-header">
                    <span class="fact-type-icon">${icon}</span>
                    <span class="fact-type">${result.type || 'article'}</span>
                </div>
                
                <div class="fact-title">${escapeHtml(result.title)}</div>
                
                ${result.excerpt ? `<div class="fact-excerpt">${escapeHtml(result.excerpt)}</div>` : ''}
                
                ${result.ai_explanation ? `
                    <div class="ai-explanation">
                        <strong>Why this matters:</strong> ${escapeHtml(result.ai_explanation)}
                    </div>
                ` : ''}
                
                <div class="fact-footer">
                    <div class="fact-source">
                        Source: <a href="${result.url}" target="_blank" onclick="event.stopPropagation()">${escapeHtml(result.source)}</a>
                        ${result.date ? ` ‚Ä¢ ${result.date}` : ''}
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button class="save-btn" onclick="event.stopPropagation(); saveToNotebook('${escapeHtml(result.title)}', '${result.url}', '${escapeHtml(result.excerpt || '')}', '${selectedTopic}', false)" style="flex: 1;">
                            üíæ Save
                        </button>
                        <button class="save-btn" onclick="event.stopPropagation(); saveToNotebook('${escapeHtml(result.title)}', '${result.url}', '${escapeHtml(result.excerpt || '')}', '${selectedTopic}', true)" style="flex: 1; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            ü§ñ Save + Summarize
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    resultsContainer.innerHTML = html;
}

function saveToNotebook(title, url, description, topic, autoSummarize = false) {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = autoSummarize ? 'ü§ñ Saving...' : 'üíæ Saving...';
    btn.disabled = true;
    
    // Show summarizing state for AI saves
    if (autoSummarize) {
        setTimeout(() => {
            if (btn.innerHTML.includes('Saving')) {
                btn.innerHTML = 'ü§ñ Summarizing...';
            }
        }, 1000);
    }
    
    fetch('/notebook/quick-save/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}&description=${encodeURIComponent(description)}&topic=${topic}&source=fact-finder&auto_summarize=${autoSummarize}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            btn.innerHTML = '‚úÖ Saved!';
            btn.style.background = '#10b981';
            
            // Show notification with link to notebook
            showNotification(`Saved to notebook under ${selectedTopicName}`, data.notebook_url);
        } else {
            btn.innerHTML = '‚ùå ' + (data.error || 'Error');
        }
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            btn.style.background = '';
        }, 3000);
    })
    .catch(error => {
        console.error('Save error:', error);
        btn.innerHTML = '‚ùå Error';
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 2000);
    });
}

function showNotification(message, notebookUrl) {
    // Create notification element
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 14px;
        font-weight: 600;
        animation: slideIn 0.3s ease-out;
    `;
    
    notification.innerHTML = `
        <span>‚úì</span>
        <span>${message}</span>
        <a href="${notebookUrl}" style="color: white; text-decoration: underline; margin-left: 8px;">View ‚Üí</a>
    `;
    
    document.body.appendChild(notification);
    
    // Remove after 4 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}

// Add animation CSS
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
