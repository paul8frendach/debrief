{% extends 'cards/base.html' %}

{% block title %}{{ topic_display }} Survey - Debrief{% endblock %}

{% block extra_style %}
.context-box {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    border-left: 4px solid #667eea;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
}

.context-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
}

.context-icon {
    font-size: 20px;
}

.context-title {
    font-size: 14px;
    font-weight: 700;
    color: #667eea;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.context-stats {
    color: #d0d0e0;
    font-size: 14px;
    line-height: 1.8;
    margin-bottom: 12px;
}

.context-stats p {
    margin: 0;
}

.learn-more-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 8px 0;
    color: #a0b5ff;
    font-size: 13px;
    font-weight: 600;
    transition: color 0.2s;
}

.learn-more-toggle:hover {
    color: #667eea;
}

.toggle-icon {
    font-size: 10px;
    transition: transform 0.3s;
}

.toggle-icon.open {
    transform: rotate(90deg);
}

.learn-more-content {
    padding: 16px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    margin-top: 8px;
    color: #b0b0c0;
    font-size: 13px;
    line-height: 1.7;
}

.sources {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    font-size: 12px;
}

.sources a {
    color: #667eea;
    text-decoration: none;
    margin-left: 4px;
}

.sources a:hover {
    text-decoration: underline;
}

.fact-search-box {
    background: rgba(255, 255, 255, 0.03);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 24px;
}

.search-header {
    display: flex;
    align-items: center;
    gap: 12px;
}

.search-icon {
    font-size: 20px;
}

.fact-search-input {
    flex: 1;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    padding: 10px 16px;
    color: white;
    font-size: 14px;
}

.fact-search-input:focus {
    outline: none;
    border-color: #667eea;
    background: rgba(255, 255, 255, 0.08);
}

.fact-search-input::placeholder {
    color: rgba(255, 255, 255, 0.4);
}

.fact-results {
    margin-top: 16px;
    max-height: 400px;
    overflow-y: auto;
}

.fact-result-item {
    background: rgba(255, 255, 255, 0.05);
    border-left: 3px solid #10b981;
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

.fact-result-item:hover {
    background: rgba(255, 255, 255, 0.08);
    transform: translateX(4px);
}

.fact-title {
    font-size: 14px;
    font-weight: 600;
    color: white;
    margin-bottom: 4px;
}

.fact-excerpt {
    font-size: 12px;
    color: #b0b0c0;
    line-height: 1.5;
    margin-bottom: 8px;
}

.fact-source {
    font-size: 11px;
    color: #808090;
}

.fact-source-link {
    color: #667eea;
    text-decoration: none;
}

.fact-source-link:hover {
    text-decoration: underline;
}

.search-loading {
    text-align: center;
    padding: 20px;
    color: #808090;
    font-size: 13px;
}

.ai-suggestions-box {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
    border: 2px solid rgba(16, 185, 129, 0.3);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
}

.ai-header {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 700;
    color: #10b981;
    margin-bottom: 12px;
    font-size: 14px;
}

.ai-icon {
    font-size: 18px;
}

.suggestion-section {
    margin-bottom: 12px;
}

.suggestion-label {
    font-size: 12px;
    font-weight: 600;
    color: #d0d0e0;
    margin-bottom: 8px;
}

.suggestion-chip {
    display: inline-block;
    background: rgba(102, 126, 234, 0.2);
    border: 1px solid #667eea;
    color: #a0b5ff;
    padding: 6px 12px;
    border-radius: 16px;
    margin: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

.suggestion-chip:hover {
    background: rgba(102, 126, 234, 0.3);
    transform: translateY(-2px);
}

.key-terms {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.key-term {
    background: rgba(16, 185, 129, 0.2);
    border: 1px solid #10b981;
    color: #6ee7b7;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

.research-tip {
    color: #b0b0c0;
    font-size: 12px;
    line-height: 1.6;
    margin: 4px 0;
}

.fact-result-item.ai-recommended {
    border-left: 4px solid #10b981;
    background: rgba(16, 185, 129, 0.08);
}

.recommended-badge {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    font-size: 10px;
    font-weight: 700;
    padding: 4px 8px;
    border-radius: 8px;
    display: inline-block;
    margin-bottom: 8px;
}

.result-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 8px;
}

.result-type-icon {
    font-size: 16px;
}

.result-type {
    font-size: 10px;
    text-transform: uppercase;
    color: #808090;
    font-weight: 600;
    letter-spacing: 0.5px;
}

.ai-explanation {
    background: rgba(16, 185, 129, 0.1);
    border-left: 3px solid #10b981;
    padding: 8px 12px;
    margin: 8px 0;
    font-size: 12px;
    color: #d0d0e0;
    border-radius: 4px;
}

.ai-explanation strong {
    color: #10b981;
}

.bias-info {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 8px 0;
    font-size: 11px;
}

.bias-label {
    color: #808090;
    font-weight: 600;
}

.bias-stats {
    background: rgba(102, 126, 234, 0.2);
    padding: 2px 8px;
    border-radius: 8px;
    color: #a0b5ff;
    font-weight: 600;
}

.perspectives {
    color: #808090;
    font-style: italic;
}

.save-to-notebook-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 8px;
    transition: all 0.2s;
    width: 100%;
}

.save-to-notebook-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.save-to-notebook-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.loading-spinner {
    font-size: 24px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.empty-icon {
    font-size: 48px;
    margin-bottom: 12px;
}

.empty-title {
    font-size: 16px;
    font-weight: 700;
    color: #d0d0e0;
    margin-bottom: 8px;
}

.empty-suggestion {
    font-size: 13px;
    color: #808090;
    margin-bottom: 12px;
}

.suggestion-chip-empty {
    background: rgba(102, 126, 234, 0.2);
    border: 1px solid #667eea;
    color: #a0b5ff;
    padding: 8px 16px;
    border-radius: 12px;
    margin: 8px;
    display: inline-block;
    font-size: 13px;
}

.search-empty {
    text-align: center;
    padding: 20px;
    color: #808090;
    font-size: 13px;
}

.survey-container {
    max-width: 900px;
    margin: 60px auto;
    padding: 0 20px;
}

.survey-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    padding: 40px;
    margin-bottom: 32px;
    text-align: center;
    color: white;
}

.survey-title {
    font-size: 36px;
    font-weight: 800;
    margin-bottom: 12px;
}

.survey-description {
    font-size: 16px;
    line-height: 1.8;
    opacity: 0.95;
    background: rgba(0,0,0,0.2);
    padding: 20px;
    border-radius: 12px;
    margin-top: 20px;
}

.progress-bar {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 32px;
    border: 1px solid rgba(255,255,255,0.1);
}

.progress-track {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
}

.progress-step {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: #808090;
    font-size: 14px;
}

.progress-step.completed {
    background: #10b981;
    border-color: #10b981;
    color: white;
}

.progress-step.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-color: #667eea;
    color: white;
    transform: scale(1.2);
}

.progress-fill {
    height: 6px;
    background: rgba(255,255,255,0.1);
    border-radius: 3px;
    overflow: hidden;
}

.progress-fill-bar {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    transition: width 0.4s ease;
}

.question-card {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-radius: 16px;
    padding: 40px;
    margin-bottom: 32px;
    border: 1px solid rgba(255,255,255,0.1);
    display: none;
}

.question-card.active {
    display: block;
    animation: slideIn 0.4s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.question-number {
    font-size: 14px;
    font-weight: 700;
    color: #667eea;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 12px;
}

.question-text {
    font-size: 24px;
    font-weight: 700;
    color: white;
    margin-bottom: 32px;
    line-height: 1.4;
}

.options-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.option-bubble {
    background: rgba(255,255,255,0.03);
    border: 3px solid rgba(255,255,255,0.1);
    border-radius: 20px;
    padding: 24px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.option-bubble::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.option-bubble:hover {
    border-color: #667eea;
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
}

.option-bubble.selected {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.15);
}

.option-bubble.selected::before {
    opacity: 0.1;
}

.option-content {
    position: relative;
    z-index: 1;
}

.option-emoji {
    font-size: 32px;
    margin-bottom: 12px;
    display: block;
}

.option-text {
    font-size: 15px;
    font-weight: 600;
    color: white;
    line-height: 1.5;
}

.option-bubble.selected .option-text {
    color: white;
}

.option-bubble input[type="radio"] {
    display: none;
}

.navigation-buttons {
    display: flex;
    justify-content: space-between;
    gap: 16px;
    margin-top: 32px;
}

.btn {
    padding: 14px 32px;
    border-radius: 10px;
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-secondary {
    background: rgba(255,255,255,0.1);
    color: white;
    border: 2px solid rgba(255,255,255,0.2);
}

.btn-secondary:hover {
    background: rgba(255,255,255,0.15);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
}

.btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.btn-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    flex: 1;
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
}

@media (max-width: 768px) {
    .options-grid {
        grid-template-columns: 1fr;
    }
    
    .survey-title {
        font-size: 28px;
    }
    
    .question-text {
        font-size: 20px;
    }
}
{% endblock %}

{% block content %}
<div class="survey-container">
    <!-- Header -->
    <div class="survey-header">
        <h1 class="survey-title">üìä {{ survey.title }}</h1>
        <div class="survey-description">{{ survey.description|safe }}</div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container">
        <div class="progress-text" style="color: #a0a0c0; font-size: 14px; margin-bottom: 12px;">
            Question <span id="currentQuestionDisplay">1</span> of {{ questions.count }}
        </div>
        <div class="progress-bar">
            <div class="progress-track">
                {% for question in questions %}
                <div class="progress-step {% if forloop.first %}active{% endif %}" data-step="{{ forloop.counter }}" id="step{{ forloop.counter }}">
                    <div class="step-number">{{ forloop.counter }}</div>
                </div>
                {% endfor %}
            </div>
            <div class="progress-fill">
                <div class="progress-fill-bar" id="progressBar" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Survey Form -->
    <form id="surveyForm" method="POST" action="{% url 'process_survey' survey.topic %}">
        {% csrf_token %}
        
        {% for question in questions %}
        <div class="question-card {% if forloop.first %}active{% endif %}" data-question="{{ forloop.counter }}">
            <div class="question-number">Question {{ forloop.counter }} of {{ questions|length }}</div>
            <h2 class="question-text">{{ question.question_text }}</h2>
            
            <!-- Context Stats -->
            {% if question.context_stats %}
            <div class="context-box">
                <div class="context-header">
                    <span class="context-icon">üìä</span>
                    <span class="context-title">Quick Context</span>
                </div>
                <div class="context-stats">
                    {{ question.context_stats|linebreaks }}
                </div>
                
                {% if question.learn_more %}
                <div class="learn-more-toggle" onclick="toggleLearnMore({{ question.id }})">
                    <span class="toggle-icon" id="toggleIcon{{ question.id }}">‚ñ∂</span>
                    <span class="toggle-text">Learn More</span>
                </div>
                <div class="learn-more-content" id="learnMore{{ question.id }}" style="display: none;">
                    <p>{{ question.learn_more }}</p>
                    {% if question.sources %}
                    <div class="sources">
                        <strong>Sources:</strong> <a href="{{ question.sources }}" target="_blank" rel="noopener">View Sources</a>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Fact Search Bar -->
            <div class="fact-search-box">
                <div class="search-header">
                    <span class="search-icon">üîç</span>
                    <input 
                        type="text" 
                        class="fact-search-input" 
                        placeholder="Search for facts about this topic..."
                        id="factSearch{{ question.id }}"
                        onkeyup="searchFacts(this.value, '{{ survey.topic }}', {{ question.id }})"
                    >
                </div>
                <div class="fact-results" id="factResults{{ question.id }}" style="display: none;"></div>
            </div>
            
            <div class="options-grid">
                {% for option in question.options.all %}
                <label class="option-bubble" data-question-id="{{ question.id }}" data-option-id="{{ option.id }}">
                    {% if question.order == 1 or question.order == 9 %}
                    <input type="radio" name="question_{{ question.id }}" value="{{ option.id }}" required>
                    {% else %}
                    <input type="checkbox" name="question_{{ question.id }}" value="{{ option.id }}">
                    {% endif %}
                    <div class="option-content">
                        <div class="option-text">{{ option.option_text }}</div>
                    </div>
                </label>
                {% endfor %}
            </div>
            
            <div class="navigation-buttons">
                {% if not forloop.first %}
                <button type="button" class="btn btn-secondary" onclick="previousQuestion()">
                    ‚Üê Previous
                </button>
                {% else %}
                <div></div>
                {% endif %}
                
                {% if forloop.counter == questions.count %}
                <button type="button" class="btn btn-primary" onclick="completeForm()" id="nextBtn{{ forloop.counter }}" disabled style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    ‚ú® View My Card Preview
                </button>
                {% else %}
                <button type="button" class="btn btn-primary" onclick="nextQuestion()" disabled id="nextBtn{{ forloop.counter }}">
                    Next ‚Üí
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        
        <!-- Completion Message -->
        <div class="completion-message" id="completionMessage" style="display: none;">
            <div class="completion-icon">‚ú®</div>
            <h2 class="completion-title">Survey Complete!</h2>
            <p class="completion-text">Generating your pre-filled argument card based on your responses. You'll be able to review and edit before publishing!</p>
            <button type="submit" class="btn btn-primary" style="background: white; color: #10b981;">View My Card Preview ‚Üí</button>
        </div>
    </form>
</div>

<script>
let currentQuestionNum = 1;
const totalQuestions = {{ questions.count }};
const responses = {};

// Handle option selection
document.querySelectorAll('.option-bubble').forEach(bubble => {
    bubble.addEventListener('click', function(e) {
        e.preventDefault();
        const questionId = this.dataset.questionId;
        const optionId = this.dataset.optionId;
        const input = this.querySelector('input[type="radio"], input[type="checkbox"]');
        
        if (input.type === 'radio') {
            // Deselect all options for this question
            document.querySelectorAll(`.option-bubble[data-question-id="${questionId}"]`).forEach(b => {
                b.classList.remove('selected');
                const inp = b.querySelector('input');
                if (inp) inp.checked = false;
            });
            
            // Select this option
            this.classList.add('selected');
            input.checked = true;
        } else {
            // Checkbox - toggle
            if (this.classList.contains('selected')) {
                this.classList.remove('selected');
                input.checked = false;
            } else {
                this.classList.add('selected');
                input.checked = true;
            }
        }
        
        // Check how many are selected for this question
        const selected = document.querySelectorAll(`.option-bubble[data-question-id="${questionId}"].selected`);
        console.log(`Question ${questionId}: ${selected.length} selected`);
        
        // Enable next button if at least one option selected for current question
        const currentCard = document.querySelector(`.question-card[data-question="${currentQuestionNum}"]`);
        const currentQuestionId = currentCard.querySelector('.option-bubble').dataset.questionId;
        const currentSelected = document.querySelectorAll(`.option-bubble[data-question-id="${currentQuestionId}"].selected`);
        
        const nextBtn = document.getElementById(`nextBtn${currentQuestionNum}`);
        if (nextBtn) {
            nextBtn.disabled = currentSelected.length === 0;
            console.log(`Button enabled: ${currentSelected.length > 0}`);
        }
    });
});

function updateProgress() {
    const progress = (currentQuestionNum / totalQuestions) * 100;
    const progressBar = document.getElementById('progressBar');
    if (progressBar) {
        progressBar.style.width = progress + '%';
    }
    
    // Update current question display
    const currentDisplay = document.getElementById('currentQuestionDisplay');
    if (currentDisplay) {
        currentDisplay.textContent = currentQuestionNum;
    }
    
    // Update step indicators
    document.querySelectorAll('.progress-step').forEach((step, index) => {
        const stepNum = index + 1;
        
        if (stepNum < currentQuestionNum) {
            // Mark as completed
            step.classList.add('completed');
            step.classList.remove('active');
        } else if (stepNum === currentQuestionNum) {
            // Mark as active
            step.classList.add('active');
            step.classList.remove('completed');
        } else {
            // Not yet reached
            step.classList.remove('active', 'completed');
        }
    });
}

function nextQuestion() {
    // Check if current question has at least one selection
    const currentCard = document.querySelector(`.question-card[data-question="${currentQuestionNum}"]`);
    const selectedOptions = currentCard.querySelectorAll('.option-bubble.selected');
    
    if (selectedOptions.length === 0) {
        alert('Please select at least one option before continuing');
        return;
    }
    
    if (currentQuestionNum < totalQuestions) {
        // Hide current question
        currentCard.classList.remove('active');
        
        // Show next question
        currentQuestionNum++;
        document.querySelector(`.question-card[data-question="${currentQuestionNum}"]`).classList.add('active');
        
        // Reset next button for new question
        const nextBtn = document.getElementById(`nextBtn${currentQuestionNum}`);
        const selectedInNext = document.querySelector(`.question-card[data-question="${currentQuestionNum}"]`).querySelectorAll('.option-bubble.selected');
        if (nextBtn) {
            nextBtn.disabled = selectedInNext.length === 0;
        }
        
        updateProgress();
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function previousQuestion() {
    if (currentQuestionNum > 1) {
        // Hide current question
        document.querySelector(`.question-card[data-question="${currentQuestionNum}"]`).classList.remove('active');
        
        // Show previous question
        currentQuestionNum--;
        document.querySelector(`.question-card[data-question="${currentQuestionNum}"]`).classList.add('active');
        
        updateProgress();
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function completeForm() {
    // Hide all question cards
    document.querySelectorAll('.question-card').forEach(card => {
        card.classList.remove('active');
    });
    
    // Show completion message
    const completionMsg = document.getElementById('completionMessage');
    if (completionMsg) {
        completionMsg.classList.add('active');
    }
    
    // Update progress to 100%
    const progressBar = document.getElementById('progressBar');
    if (progressBar) {
        progressBar.style.width = '100%';
    }
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Initialize progress
updateProgress();


// Toggle Learn More section
function toggleLearnMore(questionId) {
    const content = document.getElementById('learnMore' + questionId);
    const icon = document.getElementById('toggleIcon' + questionId);
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.classList.add('open');
        icon.textContent = '‚ñº';
    } else {
        content.style.display = 'none';
        icon.classList.remove('open');
        icon.textContent = '‚ñ∂';
    }
}

// Search facts with debounce and AI enhancement
let searchTimeout;
function searchFacts(query, topic, questionId) {
    clearTimeout(searchTimeout);
    
    const resultsDiv = document.getElementById('factResults' + questionId);
    
    if (query.length < 3) {
        resultsDiv.style.display = 'none';
        return;
    }
    
    // Show loading with AI indicator
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = `
        <div class="search-loading">
            <div class="loading-spinner">üîç</div>
            <div>Searching with AI assistance...</div>
        </div>
    `;
    
    // Debounce search
    searchTimeout = setTimeout(() => {
        fetch(`/api/enhanced-fact-search/?q=${encodeURIComponent(query)}&topic=${topic}`)
            .then(response => response.json())
            .then(data => {
                displayEnhancedResults(data, questionId, topic);
            })
            .catch(error => {
                console.error('Fact search error:', error);
                // Fallback to basic search
                fetch(`/api/search-facts/?q=${encodeURIComponent(query)}&topic=${topic}`)
                    .then(response => response.json())
                    .then(data => {
                        displayFactResults(data.results, questionId);
                    })
                    .catch(() => {
                        resultsDiv.innerHTML = '<div class="search-empty">Error loading results. Please try again.</div>';
                    });
            });
    }, 800); // Longer delay for AI processing
}

function displayFactResults(results, questionId) {
    const resultsDiv = document.getElementById('factResults' + questionId);
    
    if (!results || results.length === 0) {
        resultsDiv.innerHTML = '<div class="search-empty">No results found. Try different keywords.</div>';
        return;
    }
    
    let html = '';
    results.forEach(result => {
        html += `
            <div class="fact-result-item" onclick="window.open('${result.url}', '_blank')">
                <div class="fact-title">${escapeHtml(result.title)}</div>
                ${result.excerpt ? `<div class="fact-excerpt">${escapeHtml(result.excerpt.substring(0, 150))}...</div>` : ''}
                <div class="fact-source">
                    Source: <a href="${result.url}" target="_blank" class="fact-source-link" onclick="event.stopPropagation()">${escapeHtml(result.source)}</a>
                    ${result.date ? ` ‚Ä¢ ${result.date}` : ''}
                </div>
            </div>
        `;
    });
    
    resultsDiv.innerHTML = html;
}

function displayEnhancedResults(data, questionId, topic) {
    const resultsDiv = document.getElementById('factResults' + questionId);
    
    if (!data.results || data.results.length === 0) {
        resultsDiv.innerHTML = generateNoResultsHTML(data.suggestions);
        return;
    }
    
    let html = '';
    
    // Show AI suggestions if available
    if (data.suggestions && data.query_enhanced) {
        html += generateSuggestionsHTML(data.suggestions, questionId, topic);
    }
    
    // Show results with enhanced info
    data.results.forEach((result, index) => {
        html += generateResultCard(result, index, questionId, topic);
    });
    
    resultsDiv.innerHTML = html;
}

function generateSuggestionsHTML(suggestions, questionId, topic) {
    let html = '<div class="ai-suggestions-box">';
    html += '<div class="ai-header"><span class="ai-icon">‚ú®</span> AI Suggestions</div>';
    
    // Better search queries
    if (suggestions.better_queries && suggestions.better_queries.length > 0) {
        html += '<div class="suggestion-section">';
        html += '<div class="suggestion-label">Try these searches:</div>';
        suggestions.better_queries.forEach(query => {
            html += `<button class="suggestion-chip" onclick="document.getElementById('factSearch${questionId}').value = '${escapeHtml(query)}'; searchFacts('${escapeHtml(query)}', '${topic}', ${questionId});">
                ${escapeHtml(query)}
            </button>`;
        });
        html += '</div>';
    }
    
    // Key terms
    if (suggestions.key_terms && suggestions.key_terms.length > 0) {
        html += '<div class="suggestion-section">';
        html += '<div class="suggestion-label">Key terms to understand:</div>';
        html += '<div class="key-terms">';
        suggestions.key_terms.forEach(term => {
            html += `<span class="key-term">${escapeHtml(term)}</span>`;
        });
        html += '</div></div>';
    }
    
    // Research tips
    if (suggestions.research_tips && suggestions.research_tips.length > 0) {
        html += '<div class="suggestion-section">';
        html += '<div class="suggestion-label">üí° Research tips:</div>';
        suggestions.research_tips.forEach(tip => {
            html += `<div class="research-tip">‚Ä¢ ${escapeHtml(tip)}</div>`;
        });
        html += '</div>';
    }
    
    html += '</div>';
    return html;
}

function generateResultCard(result, index, questionId, topic) {
    const isRecommended = result.ai_recommended;
    const hasExplanation = result.ai_explanation && result.ai_explanation.length > 0;
    
    let html = `<div class="fact-result-item ${isRecommended ? 'ai-recommended' : ''}" onclick="window.open('${result.url}', '_blank')">`;
    
    // Recommended badge
    if (isRecommended) {
        html += '<div class="recommended-badge">‚≠ê AI Recommended</div>';
    }
    
    // Result type indicator
    const typeIcons = {
        'news': 'üì∞',
        'fact': 'üìä',
        'overview': 'üìñ'
    };
    const icon = typeIcons[result.type] || 'üìÑ';
    
    html += `<div class="result-header">
        <span class="result-type-icon">${icon}</span>
        <span class="result-type">${result.type || 'article'}</span>
    </div>`;
    
    // Title
    html += `<div class="fact-title">${escapeHtml(result.title)}</div>`;
    
    // Excerpt
    if (result.excerpt) {
        html += `<div class="fact-excerpt">${escapeHtml(result.excerpt.substring(0, 150))}...</div>`;
    }
    
    // AI Explanation
    if (hasExplanation) {
        html += `<div class="ai-explanation">
            <strong>Why this matters:</strong> ${escapeHtml(result.ai_explanation)}
        </div>`;
    }
    
    // Bias distribution for Ground News
    if (result.bias_distribution) {
        html += `<div class="bias-info">
            <span class="bias-label">Coverage:</span>
            <span class="bias-stats">${result.bias_distribution}</span>
            <span class="perspectives">(${result.perspectives} sources)</span>
        </div>`;
    }
    
    // Source and date
    html += `<div class="fact-source">
        Source: <a href="${result.url}" target="_blank" class="fact-source-link" onclick="event.stopPropagation()">${escapeHtml(result.source)}</a>
        ${result.date ? ` ‚Ä¢ ${result.date}` : ''}
    </div>`;
    
    // Save to Notebook button
    html += `<button class="save-to-notebook-btn" onclick="event.stopPropagation(); saveToNotebook('${escapeHtml(result.title)}', '${result.url}', '${escapeHtml(result.excerpt || '')}', '${topic}')">
        üíæ Save to Notebook
    </button>`;
    
    html += '</div>';
    return html;
}

function generateNoResultsHTML(suggestions) {
    let html = '<div class="search-empty">';
    html += '<div class="empty-icon">üîç</div>';
    html += '<div class="empty-title">No results found</div>';
    
    if (suggestions && suggestions.better_queries && suggestions.better_queries.length > 0) {
        html += '<div class="empty-suggestion">Try one of these searches:</div>';
        suggestions.better_queries.forEach(query => {
            html += `<div class="suggestion-chip-empty">${escapeHtml(query)}</div>`;
        });
    } else {
        html += '<div class="empty-suggestion">Try different keywords or be more specific</div>';
    }
    
    html += '</div>';
    return html;
}

function saveToNotebook(title, url, description, topic) {
    // Show saving indicator
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ Saving...';
    btn.disabled = true;
    
    // Send to backend
    fetch('/notebook/quick-save/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}&description=${encodeURIComponent(description)}&topic=${topic}&source=survey-search`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            btn.innerHTML = '‚úÖ Saved!';
            btn.style.background = '#10b981';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                btn.style.background = '';
            }, 2000);
        } else {
            btn.innerHTML = '‚ùå Error';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Save error:', error);
        btn.innerHTML = '‚ùå Error';
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 2000);
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
